# Ralph Progress Log
Started: Sat Feb 21 12:30:35 EST 2026
---

## Codebase Patterns
- Use `.venv/bin/python` and `.venv/bin/ruff` for quality checks (system python lacks project deps)
- Models use `StrEnum` (not `str, enum.Enum`) per ruff UP042 rule
- SQLAlchemy models: use `mapped_column` with multiline args for columns >100 chars
- Alembic migrations: manually create PG enums with `op.execute("CREATE TYPE ...")` then reference with `create_type=False` in Column definitions
- Alembic migration revision IDs follow pattern: alphanumeric hash, `down_revision` links to previous
- Model relationships use `foreign_keys=[field]` when multiple FK columns reference same table
- To expose routes at a different prefix, use a separate `APIRouter` variable in the same file and register with a different `app.include_router(...)` prefix in main.py
- PATCH /collaborators/{collaborator_id} (status update) is mounted at `/api`, separate from project-scoped routes at `/api/projects`
- `ProjectRole` enum (owner/admin/editor/viewer) lives in `models/collaborator.py`; `check_project_access(project_id, user, db)` is in `auth/project_access.py`
- For song/chord endpoints (accessed by ID, not project_id), load the resource first then call `check_project_access(song.project_id, ...)` directly — can't use FastAPI Depends for these
- `ProjectResponse.my_role` is populated explicitly in each endpoint using `.model_copy(update={"my_role": role})` — ORM objects don't carry this field

## 2026-02-21 - US-001
- Created `ProjectCollaborator` SQLAlchemy model in `backend/models/collaborator.py`
  - `CollaboratorRole` StrEnum: viewer, editor, admin
  - `CollaboratorStatus` StrEnum: pending, accepted, declined
  - Unique constraint on `(project_id, invitee_id)`
  - `invitee_id` has no CASCADE delete (records retained if user deleted)
  - `inviter_id` has CASCADE delete
- Added `collaborators` relationship to `Project` model (cascade all, delete-orphan)
- Updated `backend/models/__init__.py` to export new model and enums
- Created Alembic migration `a1b2c3d4e5f6_add_project_collaborators_table.py`
  - Manually creates `collaborator_role` and `collaborator_status` PG enums
  - Downgrade drops table then enums
- **Learnings for future iterations:**
  - Use `.venv/bin/ruff check .` from backend dir for linting
  - Ruff config: line-length 100, target py311, rules E/F/I/N/W/UP
  - When adding new model with multiple FKs to same table, specify `foreign_keys=[col]` on each relationship
  - `invitee_id` deliberately has no `ondelete` to retain collaborator records after user deletion
---

## 2026-02-21 - US-002
- Cleaned up `backend/routers/collaborators.py` (moved inline `CollaboratorRole` import to top-level, simplified `or_` to direct email lookup since User has no username field)
- Created `backend/schemas/collaborator.py` with `CollaboratorInviteRequest` and `CollaboratorResponse` Pydantic models
- Created `backend/tests/test_collaborators.py` with 8 tests covering all acceptance criteria
- Already registered `collaborators_router` in `main.py` under `/api/projects` prefix
- **Learnings for future iterations:**
  - `User` model has no `username` field — identifier lookup is email-only
  - Tests use in-memory SQLite via `sqlite+aiosqlite://` — all SQLAlchemy models must be imported into `Base.metadata` for tables to be created
  - Admin-can-invite path requires an accepted collaborator record; pending status alone is insufficient for elevated permissions
---

## 2026-02-21 - US-003
- Added `CollaboratorStatusUpdateRequest` schema to `backend/schemas/collaborator.py`
- Added `status_router` (separate APIRouter) in `backend/routers/collaborators.py` for standalone `/api/collaborators/{id}` PATCH endpoint
- Added PATCH `/collaborators/{collaborator_id}` (via status_router) — invitee-only, 400 if status=pending
- Added GET `/{project_id}/collaborators` — owner or accepted admin only
- Added DELETE `/{project_id}/collaborators/{collaborator_id}` — owner only, 400 if invitee is project owner
- Registered `status_router` in `backend/main.py` at `/api` prefix
- Added 11 new tests covering all acceptance criteria (19 total in test file, all passing)
- **Learnings for future iterations:**
  - Use two `APIRouter` variables in the same file when routes need different URL prefixes
  - The PATCH status endpoint is at `/api/collaborators/{id}` (not under `/api/projects`)
  - PATCH role endpoint (US-004) will be at `/api/projects/{project_id}/collaborators/{id}` — use the existing `router`
  - Test fixture `invitation` creates a pending collaborator record for reuse across tests
---

## 2026-02-21 - US-004
- Added `CollaboratorRoleUpdateRequest` Pydantic schema to `backend/schemas/collaborator.py`
- Added PATCH `/{project_id}/collaborators/{collaborator_id}` endpoint to `backend/routers/collaborators.py`
  - Owner or accepted admin can change role; returns 403 otherwise
  - Returns 404 if collaborator record not found on this project
  - Role change works regardless of collaborator status (pending or accepted)
- Added 5 new tests (24 total in test_collaborators.py, all passing)
- **Learnings for future iterations:**
  - Role update endpoint is at `/api/projects/{project_id}/collaborators/{id}` using the existing `router`
  - The `status_router` is only for the status PATCH at `/api/collaborators/{id}`
  - Admin authorization check requires both `status == accepted` AND `role == admin`
---

## 2026-02-21 - US-005
- Added `ProjectRole` StrEnum (owner/admin/editor/viewer) to `backend/models/collaborator.py`
- Created `backend/auth/project_access.py` with:
  - `check_project_access(project_id, current_user, db)` — plain async function returning `(Project, ProjectRole)` or raising 403/404
  - `get_project_access(project_id, ...)` — FastAPI Depends wrapper for project-scoped endpoints
- Updated `schemas/project.py`: added `my_role: ProjectRole | None = None` to `ProjectResponse`
- Updated `routers/projects.py`:
  - `list_projects`: queries owned + accepted collaborations, returns `my_role` for each
  - `get_project`: uses `get_project_access` Depends, returns `my_role`; accessible to all collaborators
  - `update_project`/`delete_project`: owner-only; editors get 403
- Updated `routers/songs.py`, `routers/chords.py`, `routers/sequence.py`:
  - Replaced `_get_owned_*` helpers with `_get_song_with_role`/`_get_chord_with_role` returning `(resource, role)`
  - Read endpoints (list/get): any role (owner/admin/editor/viewer)
  - Mutate endpoints (create/update/delete): editor or above; viewer gets 403
- Updated `routers/collaborators.py`: replaced inline owner-check logic with `check_project_access`
- Created `backend/tests/test_rbac.py` with 17 tests covering all acceptance criteria (137 total, all passing)
- **Learnings for future iterations:**
  - `ProjectResponse.my_role` requires explicit `.model_copy(update={"my_role": role})` since ORM objects don't have this field
  - `get_project_access` works as a FastAPI Depends when `project_id` is a path parameter; for song/chord routes use `check_project_access` directly
  - `_EDITOR_ROLES = {owner, admin, editor}` pattern for mutation checks; `_ADMIN_ROLES = {owner, admin}` for collaborator management
---
