# Ralph Progress Log
Started: Sat Feb 21 12:30:35 EST 2026
---

## Codebase Patterns
- Use `.venv/bin/python` and `.venv/bin/ruff` for quality checks (system python lacks project deps)
- Models use `StrEnum` (not `str, enum.Enum`) per ruff UP042 rule
- SQLAlchemy models: use `mapped_column` with multiline args for columns >100 chars
- Alembic migrations: manually create PG enums with `op.execute("CREATE TYPE ...")` then reference with `create_type=False` in Column definitions
- Alembic migration revision IDs follow pattern: alphanumeric hash, `down_revision` links to previous
- Model relationships use `foreign_keys=[field]` when multiple FK columns reference same table
- To expose routes at a different prefix, use a separate `APIRouter` variable in the same file and register with a different `app.include_router(...)` prefix in main.py
- PATCH /collaborators/{collaborator_id} (status update) is mounted at `/api`, separate from project-scoped routes at `/api/projects`
- `ProjectRole` enum (owner/admin/editor/viewer) lives in `models/collaborator.py`; `check_project_access(project_id, user, db)` is in `auth/project_access.py`
- For song/chord endpoints (accessed by ID, not project_id), load the resource first then call `check_project_access(song.project_id, ...)` directly — can't use FastAPI Depends for these
- `ProjectResponse.my_role` is populated explicitly in each endpoint using `.model_copy(update={"my_role": role})` — ORM objects don't carry this field
- Frontend: use `npx tsc --noEmit` for typecheck (no "typecheck" script in package.json); `npm run lint` for ESLint
- Frontend: `PendingInvitationsModal` uses `fixed inset-0 z-50` overlay pattern; loaded from Dashboard with `showInvitationsModal` state
- When backend endpoint needs enriched data (project name, inviter email), use `selectinload` to eagerly load ORM relationships, then construct the Pydantic response manually
- Frontend role gate: `canEdit = ['owner', 'admin', 'editor'].includes(project?.my_role ?? '')` — use this pattern to hide mutating UI controls from viewers

## 2026-02-21 - US-001
- Created `ProjectCollaborator` SQLAlchemy model in `backend/models/collaborator.py`
  - `CollaboratorRole` StrEnum: viewer, editor, admin
  - `CollaboratorStatus` StrEnum: pending, accepted, declined
  - Unique constraint on `(project_id, invitee_id)`
  - `invitee_id` has no CASCADE delete (records retained if user deleted)
  - `inviter_id` has CASCADE delete
- Added `collaborators` relationship to `Project` model (cascade all, delete-orphan)
- Updated `backend/models/__init__.py` to export new model and enums
- Created Alembic migration `a1b2c3d4e5f6_add_project_collaborators_table.py`
  - Manually creates `collaborator_role` and `collaborator_status` PG enums
  - Downgrade drops table then enums
- **Learnings for future iterations:**
  - Use `.venv/bin/ruff check .` from backend dir for linting
  - Ruff config: line-length 100, target py311, rules E/F/I/N/W/UP
  - When adding new model with multiple FKs to same table, specify `foreign_keys=[col]` on each relationship
  - `invitee_id` deliberately has no `ondelete` to retain collaborator records after user deletion
---

## 2026-02-21 - US-002
- Cleaned up `backend/routers/collaborators.py` (moved inline `CollaboratorRole` import to top-level, simplified `or_` to direct email lookup since User has no username field)
- Created `backend/schemas/collaborator.py` with `CollaboratorInviteRequest` and `CollaboratorResponse` Pydantic models
- Created `backend/tests/test_collaborators.py` with 8 tests covering all acceptance criteria
- Already registered `collaborators_router` in `main.py` under `/api/projects` prefix
- **Learnings for future iterations:**
  - `User` model has no `username` field — identifier lookup is email-only
  - Tests use in-memory SQLite via `sqlite+aiosqlite://` — all SQLAlchemy models must be imported into `Base.metadata` for tables to be created
  - Admin-can-invite path requires an accepted collaborator record; pending status alone is insufficient for elevated permissions
---

## 2026-02-21 - US-003
- Added `CollaboratorStatusUpdateRequest` schema to `backend/schemas/collaborator.py`
- Added `status_router` (separate APIRouter) in `backend/routers/collaborators.py` for standalone `/api/collaborators/{id}` PATCH endpoint
- Added PATCH `/collaborators/{collaborator_id}` (via status_router) — invitee-only, 400 if status=pending
- Added GET `/{project_id}/collaborators` — owner or accepted admin only
- Added DELETE `/{project_id}/collaborators/{collaborator_id}` — owner only, 400 if invitee is project owner
- Registered `status_router` in `backend/main.py` at `/api` prefix
- Added 11 new tests covering all acceptance criteria (19 total in test file, all passing)
- **Learnings for future iterations:**
  - Use two `APIRouter` variables in the same file when routes need different URL prefixes
  - The PATCH status endpoint is at `/api/collaborators/{id}` (not under `/api/projects`)
  - PATCH role endpoint (US-004) will be at `/api/projects/{project_id}/collaborators/{id}` — use the existing `router`
  - Test fixture `invitation` creates a pending collaborator record for reuse across tests
---

## 2026-02-21 - US-004
- Added `CollaboratorRoleUpdateRequest` Pydantic schema to `backend/schemas/collaborator.py`
- Added PATCH `/{project_id}/collaborators/{collaborator_id}` endpoint to `backend/routers/collaborators.py`
  - Owner or accepted admin can change role; returns 403 otherwise
  - Returns 404 if collaborator record not found on this project
  - Role change works regardless of collaborator status (pending or accepted)
- Added 5 new tests (24 total in test_collaborators.py, all passing)
- **Learnings for future iterations:**
  - Role update endpoint is at `/api/projects/{project_id}/collaborators/{id}` using the existing `router`
  - The `status_router` is only for the status PATCH at `/api/collaborators/{id}`
  - Admin authorization check requires both `status == accepted` AND `role == admin`
---

## 2026-02-21 - US-005
- Added `ProjectRole` StrEnum (owner/admin/editor/viewer) to `backend/models/collaborator.py`
- Created `backend/auth/project_access.py` with:
  - `check_project_access(project_id, current_user, db)` — plain async function returning `(Project, ProjectRole)` or raising 403/404
  - `get_project_access(project_id, ...)` — FastAPI Depends wrapper for project-scoped endpoints
- Updated `schemas/project.py`: added `my_role: ProjectRole | None = None` to `ProjectResponse`
- Updated `routers/projects.py`:
  - `list_projects`: queries owned + accepted collaborations, returns `my_role` for each
  - `get_project`: uses `get_project_access` Depends, returns `my_role`; accessible to all collaborators
  - `update_project`/`delete_project`: owner-only; editors get 403
- Updated `routers/songs.py`, `routers/chords.py`, `routers/sequence.py`:
  - Replaced `_get_owned_*` helpers with `_get_song_with_role`/`_get_chord_with_role` returning `(resource, role)`
  - Read endpoints (list/get): any role (owner/admin/editor/viewer)
  - Mutate endpoints (create/update/delete): editor or above; viewer gets 403
- Updated `routers/collaborators.py`: replaced inline owner-check logic with `check_project_access`
- Created `backend/tests/test_rbac.py` with 17 tests covering all acceptance criteria (137 total, all passing)
- **Learnings for future iterations:**
  - `ProjectResponse.my_role` requires explicit `.model_copy(update={"my_role": role})` since ORM objects don't have this field
  - `get_project_access` works as a FastAPI Depends when `project_id` is a path parameter; for song/chord routes use `check_project_access` directly
  - `_EDITOR_ROLES = {owner, admin, editor}` pattern for mutation checks; `_ADMIN_ROLES = {owner, admin}` for collaborator management
---

## 2026-02-21 - US-006
- Added `PendingInvitationResponse` Pydantic schema to `backend/schemas/collaborator.py`
  - Includes: id, project_id, project_name, inviter_email, role, status, created_at, updated_at
- Added `GET /collaborators/pending` endpoint to `status_router` in `backend/routers/collaborators.py`
  - Uses `selectinload` for `project` and `inviter` relationships to eager-load related data
  - Constructs `PendingInvitationResponse` manually from ORM object + related data
- Added 3 new tests to `backend/tests/test_collaborators.py` (140 total, all passing)
- Created `frontend/src/components/PendingInvitationsModal.tsx`
  - Fetches `GET /api/collaborators/pending` on mount
  - Shows each invitation: project name, inviter email, assigned role
  - Accept/Decline buttons call `PATCH /api/collaborators/{id}` and remove invitation from list
  - Dismiss button (X) closes modal without accepting/declining
  - Hidden automatically when no pending invitations (returns null if loading or empty)
- Updated `frontend/src/pages/Dashboard.tsx` to render `PendingInvitationsModal` (controlled by `showInvitationsModal` state)
- **Learnings for future iterations:**
  - Frontend typecheck: `npx tsc --noEmit` (run from frontend/ dir); no "typecheck" script in package.json
  - `PendingInvitationsModal` auto-hides when `invitations.length === 0` — US-007 can leverage this for "close when all resolved"
  - `selectinload` requires importing from `sqlalchemy.orm`; adds to `status_router`'s endpoint which is mounted at `/api`
  - The modal is rendered in a React fragment alongside AppLayout in Dashboard's return, using `fixed inset-0 z-50` for overlay
---

## 2026-02-21 - US-007
- Added `onAccept?: () => void` prop to `PendingInvitationsModal`
  - Called after successful PATCH accept response to trigger project list refresh
- Updated `Dashboard.tsx` to pass `onAccept={fetchProjects}` to the modal
  - Accepted project appears in dashboard immediately without page reload
- Modal already auto-hides when `invitations.length === 0` (from US-006) — satisfies "closes automatically when all resolved"
- **Learnings for future iterations:**
  - `PendingInvitationsModal` already had Accept/Decline API calls from US-006; US-007 only needed the dashboard refresh callback
  - Pattern: pass `fetchProjects` (useCallback) as `onAccept` prop — safe to call multiple times without infinite loop risk
---

## 2026-02-21 - US-008
- Added `shared_by: str | None = None` to `ProjectResponse` in `backend/schemas/project.py`
- Updated `list_projects` in `backend/routers/projects.py` to join the inviter User on `ProjectCollaborator.inviter_id` and include `inviter.email` as `shared_by` in the response
- Updated `frontend/src/pages/Dashboard.tsx`:
  - Added `my_role`, `shared_by`, and `user_id` to `Project` interface
  - Derived `ownedProjects` and `sharedProjects` from filtered project list
  - Extracted `renderProjectCard` helper for shared card rendering logic
  - Shared projects show a purple "Shared" badge next to the project title
  - Shared projects show "Shared by [email]" instead of the updated date
  - Dashboard renders two sections: "My Projects" and "Shared with Me" (section headers only visible when both types exist)
  - Rename/Delete buttons are hidden for shared projects (role enforcement in UI deferred to US-009)
- **Learnings for future iterations:**
  - `list_projects` joins `User` directly on `ProjectCollaborator.inviter_id` — SQLAlchemy returns `(collab, project, inviter)` tuples
  - `shared_by` field is `None` for owned projects, populated with inviter email for shared projects
  - Dashboard section headers ("My Projects" / "Shared with Me") only shown when both sections have entries — avoids redundant heading when only one type exists
  - `renderProjectCard` as a helper function (not a React component) works fine with `key` on the returned div — React handles keys correctly
---

## 2026-02-21 - US-009
- Updated `frontend/src/components/ChordStaff.tsx`:
  - Added optional `canEdit?: boolean` prop (default `true`) to `ChordStaffProps`, `Measure`, and `BeatSlot`
  - Hide remove-measure (×) button, repeat start/end toggles, and ending number selectors when `!canEdit`
  - Hide remove-beat popup menu when `!canEdit`; beat slot click does nothing when `!canEdit`
- Updated `frontend/src/pages/ProjectDetail.tsx`:
  - Added `my_role: string | null` to `Project` interface
  - Derived `canEdit = ['owner', 'admin', 'editor'].includes(project?.my_role ?? '')`
  - Added role badge (color-coded: owner=blue, admin=purple, editor=green, viewer=gray) below error section
  - "New Song" button and song create form hidden when `!canEdit`
  - "Rename" and "Delete" buttons on song rows hidden when `!canEdit`
- Updated `frontend/src/pages/SongDetail.tsx`:
  - Added `my_role: string | null` to `Project` interface
  - Added `canEdit: boolean` prop to `SortableChordCardProps`
  - Drag handle, move up/down, delete, and chord name click-to-edit hidden when `!canEdit`
  - Guitar neck shown as static div (not clickable button) when `!canEdit`
  - "Add Chord" button hidden when `!canEdit` (both in empty state and non-empty state)
  - Sequence section: "Add Measure", "Save Sequence", and time signature selectors hidden when `!canEdit`
  - Passed `canEdit` to `ChordStaff` component
- Typecheck and lint pass (no errors)
- **Learnings for future iterations:**
  - `canEdit = ['owner', 'admin', 'editor'].includes(project?.my_role ?? '')` is the standard pattern for mutation permission checks in the frontend
  - `ChordStaff.canEdit` flows down through `Measure` and `BeatSlot` — all three components need the prop
  - Role badge colors: owner=blue-100/700, admin=purple-100/700, editor=green-100/700, viewer=gray-100/600
  - When `project` might be null (still loading), use `project?.my_role ?? ''` for safe access
---

## 2026-02-21 - US-010
- Added `CollaboratorDetailResponse` Pydantic schema to `backend/schemas/collaborator.py`
  - Includes `invitee_email` (populated via selectinload on `invitee` relationship)
- Updated `list_collaborators` endpoint in `backend/routers/collaborators.py`
  - Uses `selectinload(ProjectCollaborator.invitee)` to eager-load invitee User
  - Returns `CollaboratorDetailResponse` with `invitee_email` instead of plain `CollaboratorResponse`
- Created `frontend/src/pages/CollaboratorsPage.tsx`
  - Fetches `GET /api/projects/{id}/collaborators` on mount
  - Lists collaborators with email, role badge (color-coded), status badge (green/yellow/gray)
  - Accepted rows are full-opacity; pending/declined rows use `opacity-75` and `bg-gray-50`
  - Invite form: email input + role dropdown (Viewer/Editor/Admin) + Submit button
  - POST `/api/projects/{id}/collaborators` on submit; re-fetches list on success
  - 404 → "No user found" error; 409 → "already has pending/accepted" error
- Updated `frontend/src/App.tsx`: added route `/projects/:id/collaborators`
- Updated `frontend/src/pages/ProjectDetail.tsx`:
  - Added `canManage = ['owner', 'admin'].includes(project?.my_role ?? '')` derived flag
  - Added "Collaborators" link button next to role badge, visible only when `canManage`
- **Learnings for future iterations:**
  - `GET /projects/{id}/collaborators` now returns `CollaboratorDetailResponse` (with `invitee_email`) not plain `CollaboratorResponse`
  - `canManage = ['owner', 'admin'].includes(project?.my_role ?? '')` for admin-gated UI controls
  - Status visual distinction: accepted rows full white, pending/declined rows `bg-gray-50 opacity-75`
---

## 2026-02-21 - US-011
- Updated `frontend/src/pages/CollaboratorsPage.tsx`:
  - Added `confirmRemoveId` and `removing` state for confirmation dialog flow
  - Added `handleRemove(collaboratorId)` async function: calls DELETE `/api/projects/{id}/collaborators/{id}`, removes row from local state on success
  - Added "Remove" button (red, text-xs) on each collaborator row, visible only when `isOwner`
  - Added confirmation dialog (fixed overlay, modal card) showing "Remove [email] from this project?" with Cancel and Remove buttons
- Backend DELETE endpoint was already implemented in US-003 — no backend changes needed
- **Learnings for future iterations:**
  - Confirmation dialog uses IIFE pattern `{confirmRemoveId && (() => { ... })()}` to access the target collaborator's email from state
  - Remove button is owner-only (`isOwner`); the `isOwner` variable was already derived in the component
  - After DELETE 204, row is removed from `collaborators` array via `setCollaborators(prev => prev.filter(...))` — no re-fetch needed
---
