## Codebase Patterns
- Frontend: React 19 + TypeScript (strict: noUnusedLocals, noUnusedParameters) + Vite + Tailwind CSS 4
- Frontend lint rule `react-refresh/only-export-components` requires non-component exports (types, utils) to live in separate files (e.g., `src/types/`)
- Frontend typecheck: `npx tsc -b --noEmit` from `frontend/` dir; lint: `npm run lint`
- Backend uses SQLAlchemy 2.0+ async with `Mapped` type hints and `mapped_column`
- All models use `UUID(as_uuid=True)` primary keys with `default=uuid.uuid4`
- Timestamps: `DateTime(timezone=True)` with `server_default=func.now()` and `onupdate=func.now()` for `updated_at`
- Foreign keys use `ondelete="CASCADE"` pattern with `index=True`
- Relationships use `back_populates` (bidirectional) with `cascade="all, delete-orphan"` on parent side
- Alembic migrations use `postgresql.UUID(as_uuid=True)` in migration files (not just `sa.UUID`)
- Tests run via `.venv/bin/pytest tests/ -x -q` from backend directory
- Ruff linter at `.venv/bin/ruff`, line length 100
- No mypy installed; typecheck is implied via ruff + Python import verification
- SQLAlchemy `default=uuid.uuid4` on primary keys runs at INSERT time, NOT at Python object construction — `obj.id` is None until flushed/committed. Explicitly pass `id=uuid.uuid4()` when you need the id before inserting (e.g., to set a FK on a related object in the same batch)
- Use `selectinload(Parent.children).selectinload(Child.grandchildren)` for eager loading nested relationships in async SQLAlchemy (avoids MissingGreenlet errors from lazy loads)
- For bulk DELETE+recreate in PUT endpoints: delete child records first (beats), then parent (measures) using `db.execute(delete(Model).where(...))` to work in both SQLite (tests) and PostgreSQL (production)
---

# Ralph Progress Log
Started: Sat Feb 21 10:55:30 EST 2026
---

## 2026-02-21 - US-001
- What was implemented: Created three SQLAlchemy models (`Sequence`, `SequenceMeasure`, `SequenceBeat`) in `backend/models/sequence.py`. Added `sequence` back-reference to `Song` model. Created Alembic migration `c3f2a1b4d5e6_add_sequence_tables.py`.
- Files changed:
  - `backend/models/sequence.py` (new)
  - `backend/models/__init__.py` (added Sequence, SequenceMeasure, SequenceBeat exports)
  - `backend/models/song.py` (added `sequence` relationship with `uselist=False`)
  - `backend/alembic/versions/c3f2a1b4d5e6_add_sequence_tables.py` (new)
- **Learnings for future iterations:**
  - The venv is at `backend/.venv/` — use `.venv/bin/pytest`, `.venv/bin/ruff`, `.venv/bin/alembic`
  - Migration files must use `postgresql.UUID(as_uuid=True)` from `sqlalchemy.dialects`, not just `sa.UUID`
  - `sequence_beat.chord_id` uses `ondelete="SET NULL"` (not CASCADE) since removing a chord shouldn't destroy beat slots
  - `UniqueConstraint` in `__table_args__` must be a tuple — trailing comma required for single-element tuple
  - Ruff line length is 100; watch for long `__table_args__` lines
---

## 2026-02-21 - US-002
- What was implemented: REST API endpoints for sequence CRUD (`GET`, `POST`, `PUT`, `DELETE /api/songs/{song_id}/sequence`). Pydantic schemas for request/response. 17 new tests covering all endpoints and auth scenarios.
- Files changed:
  - `backend/schemas/sequence.py` (new) — SequenceCreate, SequenceUpdate, SequenceResponse, nested measure/beat schemas
  - `backend/routers/sequence.py` (new) — 4 endpoints with auth + ownership checks
  - `backend/main.py` (added sequence_router)
  - `backend/tests/test_sequence.py` (new) — 17 tests
- **Learnings for future iterations:**
  - SQLAlchemy `default=uuid.uuid4` runs at INSERT time, not Python construction — pass `id=uuid.uuid4()` explicitly when the id is needed before flush
  - For bulk DELETE+recreate in PUT: delete child records (beats) first with `db.execute(delete(...))`, then parent (measures) — required for SQLite FK compatibility in tests
  - `selectinload(Sequence.measures).selectinload(SequenceMeasure.beats)` chains work correctly for nested eager loading
  - When deleting with `db.delete(sequence)` and ORM cascade, load the full relationship tree with `selectinload` first so SQLAlchemy knows what to cascade-delete in SQLite
---

## 2026-02-21 - US-004
- What was implemented: On page load, fetches existing sequence via `GET /api/songs/{id}/sequence`; if 404 initializes with 4 empty measures in 4/4. "Save Sequence" button sends full state to `PUT /api/songs/{id}/sequence`; if 404 (no sequence yet) first POSTs to create then PUTs. Success/error toasts auto-dismiss after 3 seconds.
- Files changed:
  - `frontend/src/types/sequence.ts` (added `SequenceBeatApiResponse`, `SequenceMeasureApiResponse`, `SequenceApiResponse` types)
  - `frontend/src/pages/SongDetail.tsx` (mutable sequence state, `fetchSequence` callback, `handleSaveSequence`, toast state, Save Sequence button, toast UI)
- **Learnings for future iterations:**
  - Toast pattern: `useState<{ message: string; type: 'success' | 'error' } | null>(null)` + `setTimeout(() => setToast(null), 3000)` — simple inline approach without a library
  - PUT before POST pattern: try PUT first, if 404 then POST to create + PUT again — avoids tracking `sequenceExists` before the first load
  - Sort API response arrays by position/beat_position before mapping — backend may not guarantee order
  - TypeScript strict mode: adding setters to useState is fine as long as all setters are actually used (e.g., in fetchSequence callbacks)
  - `SequenceApiResponse` placed in `src/types/sequence.ts` (not the component file) to avoid ESLint `only-export-components` issues
---

## 2026-02-21 - US-003
- What was implemented: `ChordStaff` component renders a music-staff-style display with time signature, barlines, multiple lines of measures, and empty beat slots (dashed outlines). Added "Chord Sequence" section below chord list on song detail page.
- Files changed:
  - `frontend/src/components/ChordStaff.tsx` (new) — staff display component with `TimeSignature`, `Barline`, `BeatSlot`, `Measure` sub-components
  - `frontend/src/types/sequence.ts` (new) — `SequenceBeat`, `SequenceMeasure` interfaces + `buildDefaultMeasures` utility
  - `frontend/src/pages/SongDetail.tsx` (updated) — imported ChordStaff, added sequence state (4 measures, 4/4), rendered Chord Sequence section below chord list
- **Learnings for future iterations:**
  - ESLint rule `react-refresh/only-export-components` forbids exporting non-component values (types, functions) from component files — put shared types/utils in `src/types/` or `src/utils/`
  - Frontend typecheck command: `npx tsc -b --noEmit` (run from `frontend/` dir); no separate `typecheck` npm script
  - TypeScript strict `noUnusedLocals` means unused state setters (e.g., `setSequenceMeasures`) must be removed from destructuring until actually needed
  - Browser verification was not done (no browser tool available) — manual check recommended
---
