# Ralph Progress Log
Started: Sat Feb 21 12:30:35 EST 2026
---

## Codebase Patterns
- Use `.venv/bin/python` and `.venv/bin/ruff` for quality checks (system python lacks project deps)
- Models use `StrEnum` (not `str, enum.Enum`) per ruff UP042 rule
- SQLAlchemy models: use `mapped_column` with multiline args for columns >100 chars
- Alembic migrations: manually create PG enums with `op.execute("CREATE TYPE ...")` then reference with `create_type=False` in Column definitions
- Alembic migration revision IDs follow pattern: alphanumeric hash, `down_revision` links to previous
- Model relationships use `foreign_keys=[field]` when multiple FK columns reference same table
- To expose routes at a different prefix, use a separate `APIRouter` variable in the same file and register with a different `app.include_router(...)` prefix in main.py
- PATCH /collaborators/{collaborator_id} (status update) is mounted at `/api`, separate from project-scoped routes at `/api/projects`

## 2026-02-21 - US-001
- Created `ProjectCollaborator` SQLAlchemy model in `backend/models/collaborator.py`
  - `CollaboratorRole` StrEnum: viewer, editor, admin
  - `CollaboratorStatus` StrEnum: pending, accepted, declined
  - Unique constraint on `(project_id, invitee_id)`
  - `invitee_id` has no CASCADE delete (records retained if user deleted)
  - `inviter_id` has CASCADE delete
- Added `collaborators` relationship to `Project` model (cascade all, delete-orphan)
- Updated `backend/models/__init__.py` to export new model and enums
- Created Alembic migration `a1b2c3d4e5f6_add_project_collaborators_table.py`
  - Manually creates `collaborator_role` and `collaborator_status` PG enums
  - Downgrade drops table then enums
- **Learnings for future iterations:**
  - Use `.venv/bin/ruff check .` from backend dir for linting
  - Ruff config: line-length 100, target py311, rules E/F/I/N/W/UP
  - When adding new model with multiple FKs to same table, specify `foreign_keys=[col]` on each relationship
  - `invitee_id` deliberately has no `ondelete` to retain collaborator records after user deletion
---

## 2026-02-21 - US-002
- Cleaned up `backend/routers/collaborators.py` (moved inline `CollaboratorRole` import to top-level, simplified `or_` to direct email lookup since User has no username field)
- Created `backend/schemas/collaborator.py` with `CollaboratorInviteRequest` and `CollaboratorResponse` Pydantic models
- Created `backend/tests/test_collaborators.py` with 8 tests covering all acceptance criteria
- Already registered `collaborators_router` in `main.py` under `/api/projects` prefix
- **Learnings for future iterations:**
  - `User` model has no `username` field — identifier lookup is email-only
  - Tests use in-memory SQLite via `sqlite+aiosqlite://` — all SQLAlchemy models must be imported into `Base.metadata` for tables to be created
  - Admin-can-invite path requires an accepted collaborator record; pending status alone is insufficient for elevated permissions
---

## 2026-02-21 - US-003
- Added `CollaboratorStatusUpdateRequest` schema to `backend/schemas/collaborator.py`
- Added `status_router` (separate APIRouter) in `backend/routers/collaborators.py` for standalone `/api/collaborators/{id}` PATCH endpoint
- Added PATCH `/collaborators/{collaborator_id}` (via status_router) — invitee-only, 400 if status=pending
- Added GET `/{project_id}/collaborators` — owner or accepted admin only
- Added DELETE `/{project_id}/collaborators/{collaborator_id}` — owner only, 400 if invitee is project owner
- Registered `status_router` in `backend/main.py` at `/api` prefix
- Added 11 new tests covering all acceptance criteria (19 total in test file, all passing)
- **Learnings for future iterations:**
  - Use two `APIRouter` variables in the same file when routes need different URL prefixes
  - The PATCH status endpoint is at `/api/collaborators/{id}` (not under `/api/projects`)
  - PATCH role endpoint (US-004) will be at `/api/projects/{project_id}/collaborators/{id}` — use the existing `router`
  - Test fixture `invitation` creates a pending collaborator record for reuse across tests
---
